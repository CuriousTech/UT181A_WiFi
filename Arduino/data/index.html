<!DOCTYPE html>
<html lang="en">
<head><meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>WiFi UT181A Web Page</title>
<style type="text/css">
input{
border-radius: 5px;
margin-bottom: 5px;
box-shadow: 2px 2px 12px #000000;
background-image: -moz-linear-gradient(top, #ffffff, #50a0ff);
background-image: -ms-linear-gradient(top, #ffffff, #50a0ff);
background-image: -o-linear-gradient(top, #ffffff, #50a0ff);
background-image: -webkit-linear-gradient(top, #efffff, #50a0ff);
background-image: linear-gradient(top, #ffffff, #50a0ff);
background-clip: padding-box;
}
body{width:340px;font-family: Arial, Helvetica, sans-serif; overflow:hidden;}
.range{
  overflow: hidden;
}
.dropdown {
    position: relative;
    display: inline-block;
}
.dropbtn {
    background-color: #50a0ff;
    padding: 1px;
    font-size: 12px;
	background-image: -webkit-linear-gradient(top, #efffff, #50a0ff);
	border-radius: 5px;
	margin-bottom: 5px;
	box-shadow: 2px 2px 12px #000000;
}
.btn {
    background-color: #50a0ff;
    padding: 1px;
    font-size: 12px;
    min-width: 56px;
    border: none;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: #919191;
    min-width: 60px;
    min-height: 120px;
    z-index: 1;
}
.dropdown:hover .dropdown-content {display: block;}
.dropdown:hover .dropbtn {background-color: #3e8e41;}
.dropdown:hover .btn {	background-image: -webkit-linear-gradient(top, #efffff, #50a0ff);}
#rec{
opacity:.9;
display:none;
position:absolute;
background-color:#A13131;
overflow:auto;
z-index:1;
}
</style>
<script type="text/javascript">
a=document.all
oledon=0;v=0;min=-60;max=60;mod=5;st=0;lastst=0;rate=0
va=new Array()
function startWS(){
draw_bar(0)
draw_chart()
ws=new WebSocket("ws://"+window.location.host+"/ws")
//ws=new WebSocket("ws://192.168.0.109/ws")
ws.onopen=function(evt){}
ws.onclose=function(evt){alert("Connection closed.");}
ws.onmessage=function(evt){
// console.log(evt.data)
 lines = evt.data.split(';')
 event=lines[0]
 data=lines[1]
 if(event == 'settings')
 {
 d=JSON.parse(data)
 oledon=d.o
 a.OLED.value=oledon?'ON ':'OFF'
 }
 else if(event == 'state')
 {
	d=JSON.parse(data)
	dt=new Date(d.t*1000)
	a.time.innerHTML=dt.toLocaleTimeString()
	a.value.innerHTML=d.v
	a.unit.innerHTML=fixLabel(d.u)
	a.v1.innerHTML=d.v1
	if(d.st&(1<<6))
		a.v1.setAttribute('style',d.v1=='FAIL'?'color:red':'color:green')
	a.v2.innerHTML=d.v2
	a.v3.innerHTML=d.v3
	v=+d.v
	aa=[dt,v,+d.v1,+d.v2,+d.v3]
	va.push(aa)
	min=+d.mn
	max=+d.mx
	mod=+d.md
	st=+d.st
	if(mod){
		a.bar.setAttribute('style','')
		draw_bar(d.v=='0L'?1:0)
	}else a.bar.setAttribute('style','display:none')
	draw_chart()

	if(st!=lastst){
		a.am.innerHTML=(st&(1<<4))?"AUTO":"MANUAL"
		a.h.innerHTML=(st&(1<<5))?"HOLD":""
		if(st&(1<<2)) document.getElementById('imag').src = 'diode.png'
		else if(st&(1<<1)) document.getElementById('imag').src = 'beep.png'
		else document.getElementById('imag').src = ''
		a.record.value=(st&(1<<8))?"Stop":"Record"
		recording=(st&(1<<8))?true:false
		lastst=st
	}
	if(st&(1<<11)){ //MM
		a.t1.innerHTML=v2t(+d.t1)
		a.t2.innerHTML=v2t(+d.t2)
		a.t3.innerHTML=v2t(+d.t3)
	}
	else if(st&(1<<7)){ //Peak
		a.pm.innerHTML="PeakMax"
		a.t1.innerHTML="PeakMin"
	}
 }
 else if(event == 'alert')
 {
  alert(data)
 }
 else if(event == 'print')
 {
  console.log(data)
 }
 else if(event == 'range')
 {
  d=JSON.parse(data)
  for(i=0;i<8;i++){
   item=document.getElementById('r'+i)
   item.setAttribute('style',i<d.r.length?'':'display:none')
//   if(i==idx) item.setAttribute('style','background-color:red')
   item.innerHTML=d.r[i]
  }
  for(i=0;i<5;i++){
   item=document.getElementById('o'+i)
   item.setAttribute('style',i<d.o.length?'':'display:none')
//   if(i==idx) item.setAttribute('style','background-color:red')
   item.innerHTML=d.o[i]
  }
  a.mm.innerHTML=d.l0
  a.u1.innerHTML=fixLabel(d.u1)
  a.u2.innerHTML=fixLabel(d.u2)
  a.u3.innerHTML=fixLabel(d.u3)
  a.l1.innerHTML=d.l1
  a.l2.innerHTML=d.l2
  a.l3.innerHTML=d.l3
  a.t1.innerHTML=''
  a.t2.innerHTML=''
  a.t3.innerHTML=''
  a.pm.innerHTML=''
 }
}
}

function fixLabel(s)
{
  s=String(s).replace(/~/g, '\\u03A9')
  return s.replace(/@/g, '\xB0')
}

function v2t(v)
{
s=v%60
if(s<9) s='0'+s
v/=60
m=(v%60).toFixed()
if(m<9) m='0'+m
v/=60
h=v.toFixed()
return h+':'+m+':'+s
}
function setVar(varName, value)
{
 ws.send('cmd;{"'+varName+'":'+value+'}')
}
function setA(n)
{
 setVar('range', n)
}
function setOpt(n)
{
 setVar('sel', n)
}
function oled(){
oledon=!oledon
setVar('oled', oledon)
a.OLED.value=oledon?'ON ':'OFF'
}

function draw_bar(zl){
try {
	var c2 = document.getElementById('bar')
	ctx = c2.getContext("2d")
	ctx.fillStyle = "#000";
	ctx.fillRect(0,0,c2.width,c2.height)
	ctx.fillStyle = "#FFF";
	ctx.lineWidth = 1
	ctx.strokeStyle = "#FFF"
	ctx.font = "bold 10px sans-serif";

	w=c2.width-30
  
	for(i=0;i<=60;i++)
	{
		fVal=(i*(max-min)/60)+min
		x=i/60*w+12
		if((i%mod)==0)
		{
			ctx.fillText(fVal.toFixed(), x-(String(fVal.toFixed()).length/2)*5, 10)
			ctx.beginPath()
		    ctx.moveTo(x, 15);
		    ctx.lineTo(x, 24);
		}
		else
		{
			ctx.beginPath()
		    ctx.moveTo(x, 18);
		    ctx.lineTo(x, 24);
		}
		ctx.stroke()
	}

	if(min<0)
	{
		c=w>>1
		x=v/max*c
		ctx.fillStyle = "#FFF";
		if(x<0)
		{
			if(x<-c) x=-c
			ctx.fillRect(12+c+x, 30, -x, 6);
		}
		else
		{
			if(x>c) x=c
			ctx.fillRect(12+c, 30, x, 6);
		}
		ctx.fillStyle = "#F00";
		ctx.fillRect(12+c+x, 30, 1, 6);
	}
	else // unsigned
	{
		x = v/max*w
		if(x>w) x=w
		ctx.fillStyle = "#FFF";
		ctx.fillRect(12, 30, x, 6);
		ctx.fillStyle = "#F00";
		ctx.fillRect(12+x, 30, 1, 6);
	}
}catch(err){}
}
function draw_chart(){
try {
	var c=document.getElementById('chart')
	ctx=c.getContext("2d")
	if(va.length>c.width-19) va.shift()
	ctx.fillStyle="#222"
	ctx.fillRect(0,0,c.width,c.height)
	ctx.fillStyle="#FFF"
	ctx.lineWidth=1
	ctx.font="bold 10px sans-serif"
	ctx.textAlign="right"
	h=c.height-20
	if(min<0){
		base=h/2
		range=h/2
	}else{
		base=h
		range=h
	}
	base+=10
	fVal=min
	for(i=6;i>=0;i--)
	{
		y=(i/6*h)+10
		ctx.strokeStyle="#FFF"
		ctx.fillText(fVal,20,y+3)
		fVal+=(max-min)/6
		ctx.strokeStyle="#555"
		ctx.beginPath()
	    ctx.moveTo(21,y)
	    ctx.lineTo(c.width,y)
		ctx.stroke()
	}

	ctx.strokeStyle = "#555"
	m=0
	for(i=1,x=21;i<va.length;i++,x++)
	{
		if(va[i][0].getSeconds()==0&&va[i][0].getMinutes()!=m)
		{
			ctx.beginPath()
		    ctx.moveTo(x,h+10)
		    ctx.lineTo(x,10)
			ctx.stroke()
			m=va[i][0].getMinutes()
		}
	}

	ciel=max
	colors=[0,'#FFF','#00F','#0F0','#FF0','#0FF']
	for(line=4;line>0;line--)
	{
		y=base-(va[0][line]/ciel*range)
		ctx.strokeStyle = colors[line]
		ctx.beginPath()
	    ctx.moveTo(20,y)
		for(i=1,x=21;i<va.length;i++,x++)
		{
			y=base-(va[i][line]/ciel*range)
		    ctx.lineTo(x,y)
		}
		ctx.stroke()
	}
}catch(err){}
}

function openRec()
{
 if(recording)
	setVar('stop',0)
 else
	document.getElementById('rec').style.display="inline-block";
}
function startRec()
{
 document.getElementById('rec').style.display="none"
 dur=a.duration.value
 if(dur==0) dur=60
 ws.send('cmd;{"name":"'+a.name.value+'","interval":"'+a.interval.value+'","sav":"'+dur+'"}')
}
function cancelRec()
{
 document.getElementById('rec').style.display="none";
}
function chgRate()
{
 rates=['100ms','200ms','500ms','1 sec','2 sec','5 sec','10sec','30sec',' 1 min']
 if(++rate>8) rate=0
 a.rate.value=rates[rate]
 setVar('rate',rate)
}

</script>
<body bgcolor="black" text="silver"  onload="{startWS()}">
<div><h3 align="center">WiFi UT181A</h3>

<table align=center width=360>
<tr align=center><td colspan=2><div id="time" style="font-size:small"> 0:00:00 AM</div></td><td width=70></td><td></td></tr>
<tr align=center><td width=50><td><div id="mm" width=70></div></td><td width=50><div id="h"></div></td><td width=70><div id="am">AUTO</div></td></tr>
</table>
<table align=center width=360>
<tr align=center><td width=150 align="right" colspan=2><div id="value" style="font-size:xx-large">0L</div></td><td><div id="unit">DCV</div></td>
<td><div id="pm"></div><img id="imag" src='' style="width:38px"></td></tr>
<tr><td colspan=4><canvas id="bar" width="360" height="40" style="float:center"></td></tr>
<tr><td><div id="l1"></div></td><td><div id="v1"></div></td><td><div id="u1"></div></td><td align="right"><div id="t1"></div></td></tr>
<tr><td><div id="l2"></div></td><td><div id="v2"></div></td><td><div id="u2"></div></td><td align="right"><div id="t2"></div></td></tr>
<tr><td><div id="l3"></div></td><td><div id="v3"></div></td><td><div id="u3"></div></td><td align="right"><div id="t3"></div></td></tr>
<tr><td colspan=4><input type="button" value="Hold" id="hold" onClick="{setVar('hold', 0)}">
<div id="rec"><div id="popupRec">
<h2>Record</h2>
<table width="100">
<tr><td>Name: <input id="name" name="name" placeholder="REC_1" type="text" size="10"></td></tr>
<tr><td>Interval:<input id="interval" name="interval" placeholder="1" type="text" size="10"></td></tr>
<tr><td>Duration:<input id="duration" name="duration" placeholder="60" type="text" size="10"></td></tr>
<tr><td><input type="button" id="close" value="Cancel" onclick ="cancelRec()"><input type="button" id="start" value="Start" onclick ="startRec()"></td></tr>
</table>
</div>
</div>
<div class="dropdown">
  <button class="dropbtn">Range</button>
  <div class="dropdown-content">
  <button class="btn" id="r0" onclick="setA(0)">Auto</button>
  <button class="btn" id="r1" onclick="setA(1)">6</button>
  <button class="btn" id="r2" onclick="setA(2)">60</button>
  <button class="btn" id="r3" onclick="setA(3)">600</button>
  <button class="btn" id="r4" onclick="setA(4)">6000</button>
  <button class="btn" id="r5" onclick="setA(5)">10000</button>
  <button class="btn" id="r6" onclick="setA(6)"></button>
  <button class="btn" id="r7" onclick="setA(7)"></button>
  <button class="btn" id="r8" onclick="setA(8)"></button>
  </div>
</div>
<div class="dropdown">
  <button class="dropbtn">Select</button>
  <div class="dropdown-content">
  <button class="btn" id="o0" onclick="setOpt(0)">Opt</button>
  <button class="btn" id="o1" onclick="setOpt(1)">0</button>
  <button class="btn" id="o2" onclick="setOpt(2)">0</button>
  <button class="btn" id="o3" onclick="setOpt(3)">0</button>
  <button class="btn" id="o4" onclick="setOpt(4)">0</button>
  <button class="btn" id="o5" onclick="setOpt(5)"></button>
  </div>
</div>
<input type="button" value="REL" id="REL" onClick="{setVar('rel', 0)}">
<input id='rval' type=text size=4 value='0'> &nbsp<input type="button" value="M/M" id="M/M" onClick="{setVar('mm', 0)}"> <input type="button" value="100ms" id="rate" onClick="{chgRate()}"></td></tr>
<tr><td colspan=4></td></tr>
<tr><td colspan=4><canvas id="chart" width="360" height="300" style="float:center"></td></tr>
<tr><td colspan=4>&nbsp </td></tr>
<tr><td width="95">OLED:<input type="button" value="ON" id="OLED" onClick="{oled()}"></td>
<td width="110"><input type="button" value="Save" onClick="{setVar('sav', 0)}"> <input type="button" id="record" value="Record" onClick="{openRec()}">
</td><td><input type="submit" value="Files" onClick="window.location='/files.html';"></td><td><input type="submit" value="Setup" onClick="window.location='/s';"></td></tr>
</table>
&nbsp
</div>
</body>
</html>